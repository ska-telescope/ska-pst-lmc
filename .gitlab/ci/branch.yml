
# https://gitlab.com/ska-telescope/ska-tmc/ska-tmc-integration/-/blob/main/.gitlab-ci.yml#L50
k8s-test:
  image: $SKA_K8S_TOOLS_DEPLOY_IMAGE
  stage: test
  tags:
  - k8srunner
  variables:
    KUBE_NAMESPACE: "ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA"
  before_script:
    - kubectl config get-contexts
    - '[ -f .make/k8s.mk ] || (echo "File k8s.mk not included in Makefile; exit 1")'
    - 'make help | grep k8s-test'
    - make k8s-vars
    - make k8s-install-chart
    - |- # make k8s-wait  # Workaround logic: Wait for job status to complete rather than pod status of ready        
        kubectl -n $KUBE_NAMESPACE wait \
        --for=condition=complete \
        --timeout=360s job \
          $(kubectl -n $KUBE_NAMESPACE --kubeconfig $KUBECONFIG get job -l app.kubernetes.io/name=ska-pst-recv \
            | tail -1 \
            | head -1 \
            | awk '{ print $1 }')
  script:
    - kubectl config get-contexts
    - mkdir build
    - make k8s-vars > build/ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA.log
    - make k8s-get-pods >> build/ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA.log
    - make k8s-pod-versions >> build/ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA.log
    - make k8s-describe >> build/ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA.log
    - make k8s-podlogs >> build/ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA.log
    - cat build/ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA.log
    - mv build build_k8s_test
  after_script:
    - kubectl config get-contexts
    # - kubectl config use-context ska-telescope/ska-cicd-gitlab-k8s-agents-config:psi-low-agent
    - echo $CI_JOB_NAME - $CI_JOB_STAGE
    - make k8s-uninstall-chart
    - kubectl -n $KUBE_NAMESPACE delete pods,svc,daemonsets,deployments,replicasets,statefulsets,cronjobs,jobs,ingresses,configmaps --all
    - make k8s-delete-namespace
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_ID"
    paths:
      - build_k8s_test/
    when: always
  rules:
  - exists:
    - tests/**/*
  when: always

# Include CI templates
include:
  # k8s steps
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/k8s.gitlab-ci.yml'
